name: Build Android APK

on:
  workflow_dispatch:
    inputs:
      app_name:
        description: 'App Name'
        required: true
        default: 'NY BOTS'
      web_url:
        description: 'Website URL'
        required: true
        default: 'https://example.com'
      logo_url:
        description: 'Logo URL (PNG/JPG)'
        required: true
        default: 'https://i.imgur.com/your-logo.png'
      package_name:
        description: 'Package Name (com.example.app)'
        required: true
        default: 'com.nybots.app'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup JDK
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: Install ImageMagick
      run: |
        sudo apt-get update
        sudo apt-get install -y imagemagick
        
    - name: Create Android Project Structure
      run: |
        mkdir -p app/src/main/java/com/webview/app
        mkdir -p app/src/main/res/layout
        mkdir -p app/src/main/res/values
        mkdir -p app/src/main/res/drawable
        mkdir -p app/src/main/res/mipmap-hdpi
        mkdir -p app/src/main/res/mipmap-mdpi
        mkdir -p app/src/main/res/mipmap-xhdpi
        mkdir -p app/src/main/res/mipmap-xxhdpi
        mkdir -p app/src/main/res/mipmap-xxxhdpi
        mkdir -p app/src/main/res/anim
        mkdir -p gradle/wrapper
        
    - name: Download and process app icon
      run: |
        echo "Downloading logo from: ${{ github.event.inputs.logo_url }}"
        
        # Download with retries
        for i in {1..3}; do
          if wget --timeout=30 --tries=3 -O app_icon_original.png "${{ github.event.inputs.logo_url }}"; then
            echo "Logo downloaded successfully"
            break
          else
            echo "Attempt $i failed, retrying..."
            sleep 2
          fi
        done
        
        if [ ! -f app_icon_original.png ]; then
          echo "Failed to download logo, creating default"
          # Create a simple default icon
          convert -size 512x512 xc:none -fill "#667eea" -draw "circle 256,256 256,50" app_icon_original.png
        fi
        
        # Verify it's a valid image
        if ! identify app_icon_original.png > /dev/null 2>&1; then
          echo "Downloaded file is not a valid image, creating default"
          convert -size 512x512 xc:none -fill "#667eea" -draw "circle 256,256 256,50" app_icon_original.png
        fi
        
        # Process and create all icon sizes
        echo "Creating launcher icons..."
        convert app_icon_original.png -resize 48x48 -background none -gravity center -extent 48x48 app/src/main/res/mipmap-mdpi/ic_launcher.png
        convert app_icon_original.png -resize 72x72 -background none -gravity center -extent 72x72 app/src/main/res/mipmap-hdpi/ic_launcher.png
        convert app_icon_original.png -resize 96x96 -background none -gravity center -extent 96x96 app/src/main/res/mipmap-xhdpi/ic_launcher.png
        convert app_icon_original.png -resize 144x144 -background none -gravity center -extent 144x144 app/src/main/res/mipmap-xxhdpi/ic_launcher.png
        convert app_icon_original.png -resize 192x192 -background none -gravity center -extent 192x192 app/src/main/res/mipmap-xxxhdpi/ic_launcher.png
        
        # Create splash screen logo (larger, high quality)
        echo "Creating splash screen logo..."
        convert app_icon_original.png -resize 200x200 -background none -gravity center -extent 200x200 app/src/main/res/drawable/app_logo.png
        
        echo "Icon processing complete!"
        ls -lah app/src/main/res/drawable/
        ls -lah app/src/main/res/mipmap-*/
        
    - name: Create SplashActivity.kt
      run: |
        cat > app/src/main/java/com/webview/app/SplashActivity.kt << 'KOTLIN_EOF'
        package com.webview.app

        import android.content.Intent
        import android.os.Bundle
        import android.os.Handler
        import android.os.Looper
        import android.view.animation.AnimationUtils
        import android.widget.ImageView
        import android.widget.TextView
        import androidx.appcompat.app.AppCompatActivity

        class SplashActivity : AppCompatActivity() {
            override fun onCreate(savedInstanceState: Bundle?) {
                super.onCreate(savedInstanceState)
                setContentView(R.layout.activity_splash)

                val appLogo = findViewById<ImageView>(R.id.appLogo)
                val appName = findViewById<TextView>(R.id.appName)
                val tagline = findViewById<TextView>(R.id.tagline)

                val fadeIn = AnimationUtils.loadAnimation(this, R.anim.fade_in)
                val slideUp = AnimationUtils.loadAnimation(this, R.anim.slide_up)

                appLogo.startAnimation(fadeIn)
                Handler(Looper.getMainLooper()).postDelayed({
                    appName.startAnimation(slideUp)
                }, 300)
                Handler(Looper.getMainLooper()).postDelayed({
                    tagline.startAnimation(slideUp)
                }, 600)

                Handler(Looper.getMainLooper()).postDelayed({
                    val intent = Intent(this, MainActivity::class.java)
                    startActivity(intent)
                    overridePendingTransition(android.R.anim.fade_in, android.R.anim.fade_out)
                    finish()
                }, 3000)
            }
        }
        KOTLIN_EOF
        
    - name: Create MainActivity.kt
      run: |
        cat > app/src/main/java/com/webview/app/MainActivity.kt << 'KOTLIN_EOF'
        package com.webview.app

        import android.annotation.SuppressLint
        import android.content.Context
        import android.content.pm.ActivityInfo
        import android.content.res.Configuration
        import android.graphics.Bitmap
        import android.net.ConnectivityManager
        import android.net.NetworkCapabilities
        import android.os.Bundle
        import android.os.Handler
        import android.os.Looper
        import android.view.View
        import android.view.ViewGroup
        import android.webkit.*
        import android.widget.ProgressBar
        import android.widget.Button
        import android.widget.FrameLayout
        import androidx.appcompat.app.AppCompatActivity
        import com.google.android.material.snackbar.Snackbar

        class MainActivity : AppCompatActivity() {
            private lateinit var webView: WebView
            private lateinit var progressBar: ProgressBar
            private lateinit var offlineLayout: View
            private lateinit var retryButton: Button
            private lateinit var webViewContainer: FrameLayout
            private val handler = Handler(Looper.getMainLooper())
            private var isCheckingConnection = false
            
            private var customView: View? = null
            private var customViewCallback: WebChromeClient.CustomViewCallback? = null
            private var originalOrientation: Int = 0
            private var originalSystemUiVisibility: Int = 0

            @SuppressLint("SetJavaScriptEnabled")
            override fun onCreate(savedInstanceState: Bundle?) {
                super.onCreate(savedInstanceState)
                setContentView(R.layout.activity_main)

                webView = findViewById(R.id.webView)
                progressBar = findViewById(R.id.progressBar)
                offlineLayout = findViewById(R.id.offlineLayout)
                retryButton = findViewById(R.id.retryButton)
                webViewContainer = findViewById(R.id.webViewContainer)

                originalOrientation = requestedOrientation

                setupWebView()
                
                retryButton.setOnClickListener {
                    if (isOnline()) {
                        loadWebsite()
                    } else {
                        Snackbar.make(it, "Still offline. Please check your connection.", Snackbar.LENGTH_SHORT).show()
                    }
                }

                if (isOnline()) {
                    loadWebsite()
                } else {
                    showOfflineScreen()
                }

                startConnectionMonitoring()
            }

            @SuppressLint("SetJavaScriptEnabled")
            private fun setupWebView() {
                webView.settings.apply {
                    javaScriptEnabled = true
                    domStorageEnabled = true
                    databaseEnabled = true
                    cacheMode = WebSettings.LOAD_DEFAULT
                    loadWithOverviewMode = true
                    useWideViewPort = true
                    builtInZoomControls = false
                    setSupportZoom(true)
                    mediaPlaybackRequiresUserGesture = false
                    allowFileAccess = true
                    allowContentAccess = true
                    javaScriptCanOpenWindowsAutomatically = true
                    mixedContentMode = WebSettings.MIXED_CONTENT_ALWAYS_ALLOW
                }

                webView.webViewClient = object : WebViewClient() {
                    override fun onPageStarted(view: WebView?, url: String?, favicon: Bitmap?) {
                        super.onPageStarted(view, url, favicon)
                        progressBar.visibility = View.VISIBLE
                    }

                    override fun onPageFinished(view: WebView?, url: String?) {
                        super.onPageFinished(view, url)
                        progressBar.visibility = View.GONE
                    }

                    override fun onReceivedError(view: WebView?, request: WebResourceRequest?, error: WebResourceError?) {
                        super.onReceivedError(view, request, error)
                        if (request?.isForMainFrame == true) {
                            showOfflineScreen()
                        }
                    }

                    override fun shouldOverrideUrlLoading(view: WebView?, request: WebResourceRequest?): Boolean {
                        return false
                    }
                }

                webView.webChromeClient = object : WebChromeClient() {
                    override fun onProgressChanged(view: WebView?, newProgress: Int) {
                        progressBar.progress = newProgress
                    }

                    override fun onShowCustomView(view: View?, callback: CustomViewCallback?) {
                        if (customView != null) {
                            onHideCustomView()
                            return
                        }

                        customView = view
                        customViewCallback = callback

                        // Save original state
                        originalOrientation = requestedOrientation
                        originalSystemUiVisibility = window.decorView.systemUiVisibility

                        // Hide system UI for immersive fullscreen
                        window.decorView.systemUiVisibility = (
                            View.SYSTEM_UI_FLAG_FULLSCREEN
                            or View.SYSTEM_UI_FLAG_HIDE_NAVIGATION
                            or View.SYSTEM_UI_FLAG_IMMERSIVE_STICKY
                            or View.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN
                            or View.SYSTEM_UI_FLAG_LAYOUT_HIDE_NAVIGATION
                            or View.SYSTEM_UI_FLAG_LAYOUT_STABLE
                        )

                        // Allow any orientation in fullscreen
                        requestedOrientation = ActivityInfo.SCREEN_ORIENTATION_SENSOR

                        // Add custom view to container
                        (webViewContainer.parent as ViewGroup).addView(
                            customView,
                            FrameLayout.LayoutParams(
                                ViewGroup.LayoutParams.MATCH_PARENT,
                                ViewGroup.LayoutParams.MATCH_PARENT
                            )
                        )
                        
                        webViewContainer.visibility = View.GONE
                    }

                    override fun onHideCustomView() {
                        if (customView == null) {
                            return
                        }

                        // Show WebView container again
                        webViewContainer.visibility = View.VISIBLE

                        // Remove custom view
                        (customView?.parent as? ViewGroup)?.removeView(customView)
                        customView = null

                        // Restore system UI
                        window.decorView.systemUiVisibility = originalSystemUiVisibility

                        // Restore orientation
                        requestedOrientation = originalOrientation

                        // Call the callback
                        customViewCallback?.onCustomViewHidden()
                        customViewCallback = null
                    }
                }
            }

            private fun loadWebsite() {
                val webUrl = resources.getString(R.string.web_url)
                offlineLayout.visibility = View.GONE
                webViewContainer.visibility = View.VISIBLE
                webView.loadUrl(webUrl)
            }

            private fun showOfflineScreen() {
                offlineLayout.visibility = View.VISIBLE
                webViewContainer.visibility = View.GONE
            }

            private fun isOnline(): Boolean {
                val connectivityManager = getSystemService(Context.CONNECTIVITY_SERVICE) as ConnectivityManager
                val network = connectivityManager.activeNetwork ?: return false
                val capabilities = connectivityManager.getNetworkCapabilities(network) ?: return false
                return capabilities.hasCapability(NetworkCapabilities.NET_CAPABILITY_INTERNET) &&
                       capabilities.hasCapability(NetworkCapabilities.NET_CAPABILITY_VALIDATED)
            }

            private fun startConnectionMonitoring() {
                val checkConnection = object : Runnable {
                    override fun run() {
                        if (!isCheckingConnection && customView == null) {
                            isCheckingConnection = true
                            if (isOnline() && offlineLayout.visibility == View.VISIBLE) {
                                loadWebsite()
                            } else if (!isOnline() && webViewContainer.visibility == View.VISIBLE) {
                                showOfflineScreen()
                            }
                            isCheckingConnection = false
                        }
                        handler.postDelayed(this, 5000)
                    }
                }
                handler.post(checkConnection)
            }

            @Deprecated("Deprecated in Java")
            override fun onBackPressed() {
                if (customView != null) {
                    webView.webChromeClient?.onHideCustomView()
                } else if (webView.canGoBack() && webViewContainer.visibility == View.VISIBLE) {
                    webView.goBack()
                } else {
                    super.onBackPressed()
                }
            }

            override fun onConfigurationChanged(newConfig: Configuration) {
                super.onConfigurationChanged(newConfig)
            }

            override fun onDestroy() {
                super.onDestroy()
                handler.removeCallbacksAndMessages(null)
                
                if (customView != null) {
                    webView.webChromeClient?.onHideCustomView()
                }
                
                webView.destroy()
            }

            override fun onPause() {
                super.onPause()
                webView.onPause()
            }

            override fun onResume() {
                super.onResume()
                webView.onResume()
            }
        }
        KOTLIN_EOF
        
    - name: Create activity_splash.xml
      run: |
        cat > app/src/main/res/layout/activity_splash.xml << 'XML_EOF'
        <?xml version="1.0" encoding="utf-8"?>
        <RelativeLayout xmlns:android="http://schemas.android.com/apk/res/android"
            android:layout_width="match_parent"
            android:layout_height="match_parent"
            android:background="@drawable/gradient_background">

            <LinearLayout
                android:layout_width="wrap_content"
                android:layout_height="wrap_content"
                android:layout_centerInParent="true"
                android:orientation="vertical"
                android:gravity="center">

                <ImageView
                    android:id="@+id/appLogo"
                    android:layout_width="200dp"
                    android:layout_height="200dp"
                    android:src="@drawable/app_logo"
                    android:contentDescription="App Logo"
                    android:scaleType="fitCenter"
                    android:alpha="0" />

                <TextView
                    android:id="@+id/appName"
                    android:layout_width="wrap_content"
                    android:layout_height="wrap_content"
                    android:text="@string/app_name"
                    android:textSize="48sp"
                    android:textColor="@android:color/white"
                    android:textStyle="bold"
                    android:letterSpacing="0.1"
                    android:shadowColor="#80000000"
                    android:shadowDx="0"
                    android:shadowDy="4"
                    android:shadowRadius="8"
                    android:layout_marginTop="24dp"
                    android:alpha="0" />

                <TextView
                    android:id="@+id/tagline"
                    android:layout_width="wrap_content"
                    android:layout_height="wrap_content"
                    android:text="Next Generation Automation"
                    android:textSize="16sp"
                    android:textColor="#E0FFFFFF"
                    android:layout_marginTop="12dp"
                    android:alpha="0" />

                <ProgressBar
                    android:layout_width="40dp"
                    android:layout_height="40dp"
                    android:layout_marginTop="48dp"
                    android:indeterminateTint="@android:color/white" />

            </LinearLayout>

            <TextView
                android:layout_width="wrap_content"
                android:layout_height="wrap_content"
                android:text="Powered by NY BOTS"
                android:textSize="12sp"
                android:textColor="#80FFFFFF"
                android:layout_alignParentBottom="true"
                android:layout_centerHorizontal="true"
                android:layout_marginBottom="32dp" />

        </RelativeLayout>
        XML_EOF
        
    - name: Create activity_main.xml
      run: |
        cat > app/src/main/res/layout/activity_main.xml << 'XML_EOF'
        <?xml version="1.0" encoding="utf-8"?>
        <RelativeLayout xmlns:android="http://schemas.android.com/apk/res/android"
            android:layout_width="match_parent"
            android:layout_height="match_parent"
            android:background="@android:color/black">

            <FrameLayout
                android:id="@+id/webViewContainer"
                android:layout_width="match_parent"
                android:layout_height="match_parent">

                <WebView
                    android:id="@+id/webView"
                    android:layout_width="match_parent"
                    android:layout_height="match_parent" />

            </FrameLayout>

            <ProgressBar
                android:id="@+id/progressBar"
                style="?android:attr/progressBarStyleHorizontal"
                android:layout_width="match_parent"
                android:layout_height="3dp"
                android:layout_alignParentTop="true"
                android:progressTint="#667eea"
                android:visibility="gone" />

            <LinearLayout
                android:id="@+id/offlineLayout"
                android:layout_width="match_parent"
                android:layout_height="match_parent"
                android:orientation="vertical"
                android:gravity="center"
                android:padding="40dp"
                android:visibility="gone"
                android:background="@drawable/gradient_background">

                <ImageView
                    android:layout_width="180dp"
                    android:layout_height="180dp"
                    android:src="@drawable/app_logo"
                    android:contentDescription="App Logo"
                    android:scaleType="fitCenter"
                    android:layout_marginBottom="32dp" />

                <TextView
                    android:layout_width="wrap_content"
                    android:layout_height="wrap_content"
                    android:text="@string/app_name"
                    android:textSize="32sp"
                    android:textColor="@android:color/white"
                    android:textStyle="bold"
                    android:layout_marginBottom="24dp" />

                <View
                    android:layout_width="60dp"
                    android:layout_height="4dp"
                    android:background="@android:color/white"
                    android:alpha="0.5"
                    android:layout_marginBottom="24dp" />

                <TextView
                    android:layout_width="wrap_content"
                    android:layout_height="wrap_content"
                    android:text="No Internet Connection"
                    android:textSize="22sp"
                    android:textColor="@android:color/white"
                    android:textStyle="bold"
                    android:layout_marginBottom="12dp" />

                <TextView
                    android:layout_width="wrap_content"
                    android:layout_height="wrap_content"
                    android:text="Please check your internet connection\nand try again"
                    android:textSize="15sp"
                    android:textColor="#E0FFFFFF"
                    android:textAlignment="center"
                    android:layout_marginBottom="40dp"
                    android:lineSpacingExtra="4dp" />

                <Button
                    android:id="@+id/retryButton"
                    android:layout_width="wrap_content"
                    android:layout_height="wrap_content"
                    android:text="Retry Connection"
                    android:textColor="#667eea"
                    android:textSize="16sp"
                    android:textStyle="bold"
                    android:paddingLeft="40dp"
                    android:paddingRight="40dp"
                    android:paddingTop="16dp"
                    android:paddingBottom="16dp"
                    android:background="@drawable/button_background"
                    android:elevation="4dp" />

            </LinearLayout>
        </RelativeLayout>
        XML_EOF
        
    - name: Create animations
      run: |
        cat > app/src/main/res/anim/fade_in.xml << 'XML_EOF'
        <?xml version="1.0" encoding="utf-8"?>
        <set xmlns:android="http://schemas.android.com/apk/res/android">
            <alpha
                android:duration="1200"
                android:fromAlpha="0.0"
                android:toAlpha="1.0" />
            <scale
                android:duration="1200"
                android:fromXScale="0.7"
                android:fromYScale="0.7"
                android:toXScale="1.0"
                android:toYScale="1.0"
                android:pivotX="50%"
                android:pivotY="50%" />
        </set>
        XML_EOF
        
        cat > app/src/main/res/anim/slide_up.xml << 'XML_EOF'
        <?xml version="1.0" encoding="utf-8"?>
        <set xmlns:android="http://schemas.android.com/apk/res/android">
            <alpha
                android:duration="800"
                android:fromAlpha="0.0"
                android:toAlpha="1.0" />
            <translate
                android:duration="800"
                android:fromYDelta="30%"
                android:toYDelta="0%" />
        </set>
        XML_EOF
        
    - name: Create drawable resources
      run: |
        cat > app/src/main/res/drawable/gradient_background.xml << 'XML_EOF'
        <?xml version="1.0" encoding="utf-8"?>
        <shape xmlns:android="http://schemas.android.com/apk/res/android">
            <gradient
                android:startColor="#667eea"
                android:centerColor="#764ba2"
                android:endColor="#5b4a9e"
                android:angle="135"
                android:type="linear" />
        </shape>
        XML_EOF
        
        cat > app/src/main/res/drawable/button_background.xml << 'XML_EOF'
        <?xml version="1.0" encoding="utf-8"?>
        <shape xmlns:android="http://schemas.android.com/apk/res/android">
            <solid android:color="#FFFFFF" />
            <corners android:radius="50dp" />
        </shape>
        XML_EOF
        
    - name: Create strings.xml
      run: |
        cat > app/src/main/res/values/strings.xml << EOF
        <?xml version="1.0" encoding="utf-8"?>
        <resources>
            <string name="app_name">${{ github.event.inputs.app_name }}</string>
            <string name="web_url">${{ github.event.inputs.web_url }}</string>
        </resources>
        EOF
        
    - name: Create colors.xml
      run: |
        cat > app/src/main/res/values/colors.xml << 'XML_EOF'
        <?xml version="1.0" encoding="utf-8"?>
        <resources>
            <color name="purple_200">#FFBB86FC</color>
            <color name="purple_500">#667eea</color>
            <color name="purple_700">#764ba2</color>
            <color name="teal_200">#FF03DAC5</color>
            <color name="teal_700">#FF018786</color>
            <color name="black">#FF000000</color>
            <color name="white">#FFFFFFFF</color>
        </resources>
        XML_EOF
        
    - name: Create themes.xml
      run: |
        mkdir -p app/src/main/res/values-night
        cat > app/src/main/res/values/themes.xml << 'XML_EOF'
        <?xml version="1.0" encoding="utf-8"?>
        <resources>
            <style name="Theme.WebViewApp" parent="Theme.AppCompat.Light.NoActionBar">
                <item name="colorPrimary">@color/purple_500</item>
                <item name="colorPrimaryDark">@color/purple_700</item>
                <item name="colorAccent">@color/teal_200</item>
                <item name="android:windowTranslucentStatus">true</item>
                <item name="android:windowTranslucentNavigation">false</item>
            </style>
            
            <style name="Theme.Splash" parent="Theme.AppCompat.Light.NoActionBar">
                <item name="android:windowBackground">@drawable/gradient_background</item>
                <item name="android:windowTranslucentStatus">true</item>
                <item name="android:windowTranslucentNavigation">false</item>
            </style>
        </resources>
        XML_EOF
        
    - name: Create AndroidManifest.xml
      run: |
        mkdir -p app/src/main
        cat > app/src/main/AndroidManifest.xml << EOF
        <?xml version="1.0" encoding="utf-8"?>
        <manifest xmlns:android="http://schemas.android.com/apk/res/android"
            xmlns:tools="http://schemas.android.com/tools"
            package="com.webview.app">

            <uses-permission android:name="android.permission.INTERNET" />
            <uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />
            <uses-permission android:name="android.permission.ACCESS_WIFI_STATE" />

            <application
                android:allowBackup="true"
                android:icon="@mipmap/ic_launcher"
                android:label="@string/app_name"
                android:roundIcon="@mipmap/ic_launcher"
                android:supportsRtl="true"
                android:theme="@style/Theme.WebViewApp"
                android:usesCleartextTraffic="true"
                android:hardwareAccelerated="true"
                tools:targetApi="m">
                
                <activity
                    android:name=".SplashActivity"
                    android:exported="true"
                    android:theme="@style/Theme.Splash"
                    android:screenOrientation="portrait"
                    android:configChanges="orientation|screenSize">
                    <intent-filter>
                        <action android:name="android.intent.action.MAIN" />
                        <category android:name="android.intent.category.LAUNCHER" />
                    </intent-filter>
                </activity>
                
                <activity
                    android:name=".MainActivity"
                    android:exported="false"
                    android:launchMode="singleTask"
                    android:configChanges="orientation|screenSize|keyboardHidden|screenLayout|smallestScreenSize" />
            </application>
        </manifest>
        EOF
        
    - name: Create build.gradle (app)
      run: |
        cat > app/build.gradle << 'GRADLE_EOF'
        plugins {
            id 'com.android.application'
            id 'kotlin-android'
        }

        android {
            namespace 'com.webview.app'
            compileSdk 34

            defaultConfig {
                applicationId "com.webview.app"
                minSdk 24
                targetSdk 34
                versionCode 1
                versionName "1.0"
            }

            buildTypes {
                release {
                    minifyEnabled false
                    proguardFiles getDefaultProguardFile('proguard-android-optimize.txt')
                }
            }
            
            compileOptions {
                sourceCompatibility JavaVersion.VERSION_17
                targetCompatibility JavaVersion.VERSION_17
            }
            
            kotlinOptions {
                jvmTarget = '17'
            }
        }

        dependencies {
            implementation 'androidx.core:core-ktx:1.12.0'
            implementation 'androidx.appcompat:appcompat:1.6.1'
            implementation 'com.google.android.material:material:1.11.0'
            implementation 'androidx.constraintlayout:constraintlayout:2.1.4'
        }
        GRADLE_EOF
        
    - name: Create build.gradle (root)
      run: |
        cat > build.gradle << 'GRADLE_EOF'
        buildscript {
            ext.kotlin_version = '1.9.20'
            repositories {
                google()
                mavenCentral()
            }
            dependencies {
                classpath 'com.android.tools.build:gradle:8.2.0'
                classpath "org.jetbrains.kotlin:kotlin-gradle-plugin:$kotlin_version"
            }
        }

        allprojects {
            repositories {
                google()
                mavenCentral()
            }
        }
        GRADLE_EOF
        
    - name: Create settings.gradle
      run: |
        cat > settings.gradle << 'GRADLE_EOF'
        include ':app'
        GRADLE_EOF
        
    - name: Create gradle.properties
      run: |
        cat > gradle.properties << 'PROPS_EOF'
        org.gradle.jvmargs=-Xmx2048m -Dfile.encoding=UTF-8
        android.useAndroidX=true
        android.enableJetifier=true
        kotlin.code.style=official
        android.suppressUnsupportedCompileSdk=34
        PROPS_EOF
        
    - name: Create gradle-wrapper.properties
      run: |
        cat > gradle/wrapper/gradle-wrapper.properties << 'WRAPPER_EOF'
        distributionBase=GRADLE_USER_HOME
        distributionPath=wrapper/dists
        distributionUrl=https\://services.gradle.org/distributions/gradle-8.2-bin.zip
        zipStoreBase=GRADLE_USER_HOME
        zipStorePath=wrapper/dists
        WRAPPER_EOF
        
    - name: Download Gradle Wrapper
      run: |
        wget https://raw.githubusercontent.com/gradle/gradle/master/gradle/wrapper/gradle-wrapper.jar -O gradle/wrapper/gradle-wrapper.jar
        
    - name: Create gradlew
      run: |
        wget https://raw.githubusercontent.com/gradle/gradle/master/gradlew
        chmod +x gradlew
        
    - name: Build APK
      run: |
        ./gradlew assembleDebug --stacktrace
        
    - name: Rename APK
      run: |
        APP_NAME="${{ github.event.inputs.app_name }}"
        APP_NAME_CLEAN=$(echo "$APP_NAME" | tr ' ' '_' | tr '[:upper:]' '[:lower:]')
        cp app/build/outputs/apk/debug/app-debug.apk "${APP_NAME_CLEAN}.apk"

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: android-apk
        path: "*.apk"

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v1.0.${{ github.run_number }}
        name: ${{ github.event.inputs.app_name }} v1.0.${{ github.run_number }}
        body: |
          ## ðŸš€ ${{ github.event.inputs.app_name }}
          
          **Website:** ${{ github.event.inputs.web_url }}
          **Build Number:** #${{ github.run_number }}
          **Package:** com.webview.app
          
          ### âœ¨ Features
          - ðŸŽ¨ Professional splash screen with custom logo
          - ðŸŒ Native Android WebView with Shaka Player support
          - ðŸ“± Smooth fullscreen video playback with rotation support
          - ðŸ“¡ Smart offline detection with auto-retry
          - ðŸŽ¯ Beautiful gradient UI design
          - ðŸ“Š Progress indicator
          - â†©ï¸ Smart back button navigation
          - ðŸ”„ Auto-orientation handling in fullscreen mode
          
          ### ðŸŽ¥ Video Features
          - Full immersive fullscreen mode
          - Automatic rotation support (landscape/portrait)
          - Proper exit from fullscreen with back button
          - Hardware acceleration enabled
          
          ### ðŸ“¥ Installation
          1. Download the APK file below
          2. Enable "Install from Unknown Sources" in Android settings
          3. Install and enjoy!
          
          ### ðŸ› Fixed Issues
          - âœ… Fullscreen rotation now works smoothly
          - âœ… Logo properly downloads and displays on splash screen
          - âœ… No more hanging during video rotation
          - âœ… Enhanced video player compatibility (Shaka, ExoPlayer, etc.)
        files: "*.apk"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
